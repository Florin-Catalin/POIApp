name: Clang-Tidy Check

on:
  push:
    paths:
      - '**/*.cpp'
      - '**/*.h'
  pull_request:
    paths:
      - '**/*.cpp'
      - '**/*.h'

jobs:
  clang-tidy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy qtbase5-dev qtdeclarative5-dev

      - name: Run clang-tidy
        run: |
          QT_INCLUDE_PATH=$(dpkg -L qtbase5-dev | grep '/include$' | head -n1)
          PROJECT_ROOT=$(pwd)
          IGNORED_CHECKS="-llvmlibc-restrict-system-libc-headers,-llvmlibc-callee-namespace,-llvmlibc-implementation-in-namespace,-modernize-use-trailing-return-type,-fuchsia-trailing-return,-fuchsia-default-arguments-calls"
          for file in $(find . -path ./build -prune -o -name "*.cpp" -print); do
            echo "Checking $file"
            clang-tidy "$file" -checks=*,${IGNORED_CHECKS} --header-filter="^$PROJECT_ROOT/" -- \
              -I . \
              -isystem "$QT_INCLUDE_PATH" \
              -isystem "$QT_INCLUDE_PATH/QtCore" \
              -isystem "$QT_INCLUDE_PATH/QtGui" \
              -isystem "$QT_INCLUDE_PATH/QtWidgets" \
              -isystem "$QT_INCLUDE_PATH/QtNetwork" \
              -isystem "$QT_INCLUDE_PATH/QtQml" \
              -std=c++17
          done

